<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enrollment Flow Tester</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      padding: 40px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    h1 {
      margin-bottom: 30px;
      text-align: center;
    }
    
    .scenario-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    .scenario-card h2 {
      color: #22c55e;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .flow-steps {
      background: rgba(0, 0, 0, 0.3);
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.8;
    }
    
    .flow-steps .step {
      margin: 5px 0;
      padding-left: 20px;
      position: relative;
    }
    
    .flow-steps .step::before {
      content: '‚Üí';
      position: absolute;
      left: 0;
      color: #22c55e;
      font-weight: bold;
    }
    
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s;
      margin: 5px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color: #000;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn-info {
      background: #3b82f6;
      color: white;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    
    .status-box {
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #3b82f6;
    }
    
    .logged-in { border-left-color: #22c55e; }
    .logged-out { border-left-color: #ef4444; }
    
    .actions {
      margin-top: 20px;
    }
    
    .note {
      background: rgba(255, 193, 7, 0.2);
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Enrollment Flow Tester</h1>
    
    <div id="authStatus" class="status-box">
      <strong>Checking authentication status...</strong>
    </div>
    
    <!-- Enrollment Flow Test -->
    <div class="scenario-card">
      <h2>üîê Advanced Course Enrollment Flow</h2>
      <p>Test the secure enrollment flow for advanced courses:</p>

      <div class="flow-steps">
        <div class="step">Check if user is enrolled in the course</div>
        <div class="step">If <strong>ENROLLED</strong>: Show "Join Zoom" button (no re-enrollment)</div>
        <div class="step">If <strong>NOT ENROLLED</strong>: Force login ‚Üí Payment ‚Üí Join Zoom</div>
      </div>

      <div class="actions">
        <button class="btn btn-danger" onclick="logout()">
          üö™ Logout First (Clear Token)
        </button>
        <button class="btn btn-primary" onclick="testEnrollmentFlow()">
          üß™ Test: Try to Enroll
        </button>
      </div>

      <div class="note">
        <strong>Updated Flow:</strong><br>
        ‚Ä¢ System now auto-creates student profiles during payment if missing<br>
        ‚Ä¢ No more "Student profile not found" errors<br>
        ‚Ä¢ Seamless enrollment experience for all users
      </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="scenario-card">
      <h2>‚ö° Quick Actions</h2>
      <div class="actions">
        <a href="/student/courses.html" class="btn btn-info">üìö Go to Courses Page</a>
        <a href="/auth/login.html" class="btn btn-info">üîë Go to Login</a>
        <a href="/student/check-auth.html" class="btn btn-info">üîç Check Auth Status</a>
        <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear Everything</button>
      </div>
    </div>
  </div>

  <script>
    // Check and display auth status
    function updateAuthStatus() {
      const token = localStorage.getItem('ocms_token');
      const statusBox = document.getElementById('authStatus');
      
      if (token) {
        statusBox.className = 'status-box logged-in';
        statusBox.innerHTML = `
          <strong>‚úÖ LOGGED IN</strong><br>
          <small>Token exists in localStorage</small><br>
          <small style="opacity: 0.7;">You can test Scenario B (already logged in)</small>
        `;
      } else {
        statusBox.className = 'status-box logged-out';
        statusBox.innerHTML = `
          <strong>‚ùå NOT LOGGED IN</strong><br>
          <small>No token found</small><br>
          <small style="opacity: 0.7;">You can test Scenario A (not logged in)</small>
        `;
      }
    }
    
    // Test enrollment flow
    function testEnrollmentFlow() {
      const courseId = 1;
      const courseName = 'UI/UX-Centric Flutter App Development';
      const price = 22000;

      const token = localStorage.getItem('ocms_token');
      const isLoggedIn = !!token;

      console.log('=== ADVANCED COURSE ENROLLMENT TEST ===');
      console.log('Course:', { courseId, courseName, price });
      console.log('Currently logged in:', isLoggedIn);

      // New flow: Always redirect to login with payment redirect for advanced courses
      const loginUrl = `/auth/login.html?redirect=payment&courseId=${courseId}&courseName=${encodeURIComponent(courseName)}&price=${price}`;
      console.log('‚û°Ô∏è Advanced course ‚Üí Redirecting to LOGIN with payment redirect:', loginUrl);

      const message = isLoggedIn
        ? '‚úÖ Test: Advanced Course Enrollment\n\nAlready logged in ‚Üí LOGIN page ‚Üí Auto-redirect to PAYMENT\n\nCheck the flow!'
        : '‚úÖ Test: Advanced Course Enrollment\n\nNot logged in ‚Üí LOGIN page ‚Üí PAYMENT after login\n\nCheck the flow!';

      alert(message);
      setTimeout(() => window.location.href = loginUrl, 1000);
      localStorage.removeItem('ocms_token');
      localStorage.removeItem('token');
      console.log('Logged out - tokens cleared');
      alert('‚úÖ Logged out successfully!\n\nYou can now test Scenario A.');
      updateAuthStatus();
    }
    
    // Clear all
    function clearAll() {
      localStorage.clear();
      console.log('All localStorage cleared');
      alert('‚úÖ All data cleared!\n\nRefreshing page...');
      location.reload();
    }
    
    // Go to login
    function goToLogin() {
      if (confirm('Go to login page?\n\nAfter login, come back to this tester to test Scenario B.')) {
        window.location.href = '/auth/login.html';
      }
    }
    
    // Initialize
    updateAuthStatus();
    
    // Log current state
    console.log('Enrollment Flow Tester Ready');
    console.log('Current auth state:', {
      hasToken: !!localStorage.getItem('ocms_token'),
      allKeys: Object.keys(localStorage)
    });
  </script>
</body>
</html>
