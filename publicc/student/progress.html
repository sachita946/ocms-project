<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Progress | Student Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #0b1226 0%, #0d1c42 50%, #0d5b7c 100%);
      background-attachment: fixed;
      color: #e9f2ff;
      min-height: 100vh;
      display: flex;
    }
    .layout { display: grid; grid-template-columns: 260px 1fr; width: 100%; }
    .sidebar { background: rgba(6, 9, 20, 0.9); padding: 24px; border-right: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(6px); }
    .user-card { display: flex; gap: 12px; align-items: center; margin-bottom: 22px; }
    .avatar { width: 50px; height: 50px; border-radius: 14px; display: grid; place-items: center; background: linear-gradient(140deg, #38bdf8, #06b6d4); color: #0b1226; font-weight: 700; }
    .user-meta small { color: #9bb0c9; }
    .nav { display: flex; flex-direction: column; gap: 8px; }
    .nav button { background: rgba(255,255,255,0.06); color: #e9f2ff; border: 1px solid transparent; padding: 12px 14px; border-radius: 10px; text-align: left; cursor: pointer; transition: all 0.2s ease; }
    .nav button.active, .nav button:hover { border-color: rgba(255,255,255,0.14); background: rgba(255,255,255,0.12); }
    .logout { margin-top: 18px; background: transparent; color: #f3b8b8; border-color: rgba(255,255,255,0.18); }
    main { padding: 28px; overflow-y: auto; }
    .hero { margin-bottom: 24px; }
    .hero h1 { font-size: 28px; letter-spacing: 0.3px; margin-bottom: 6px; }
    .hero p { color: #9bb0c9; }
    
    .panel { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 18px; margin-bottom: 16px; }
    
    .course-item { 
      background: rgba(255,255,255,0.04); 
      border: 1px solid rgba(255,255,255,0.08); 
      border-radius: 12px; 
      padding: 16px; 
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }
    .course-item:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); }
    
    .course-header { display: flex; justify-content: space-between; align-items: start; gap: 12px; margin-bottom: 12px; }
    .course-title { font-size: 16px; font-weight: 600; color: #fff; }
    .course-badge { display: inline-block; padding: 4px 12px; border-radius: 6px; background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.4); color: #86efac; font-size: 12px; font-weight: 600; }
    
    .progress-section { margin-bottom: 16px; }
    .progress-label { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; color: #9bb0c9; }
    .progress-bar { width: 100%; height: 10px; border-radius: 6px; background: rgba(255,255,255,0.08); overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #22c55e, #0ea5e9); transition: width 0.4s ease; border-radius: 6px; }
    
    .lesson-list { display: grid; gap: 8px; margin-top: 10px; }
    .lesson-item { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      padding: 8px 10px; 
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      font-size: 13px;
      color: #b0bcc9;
    }
    .lesson-item.completed { color: #86efac; }
    .lesson-item .check { color: #22c55e; font-weight: bold; }
    .lesson-item .pending { color: #f97316; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: #38bdf8; display: block; }
    .stat-label { font-size: 12px; color: #9bb0c9; margin-top: 6px; text-transform: uppercase; }
    
    .empty-state { text-align: center; padding: 40px 20px; color: #9bb0c9; }
    .empty-state h3 { margin-bottom: 10px; color: #e9f2ff; }
    
    .loading { text-align: center; padding: 40px; color: #9bb0c9; }
    .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #38bdf8; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    @media (max-width: 980px) { 
      .layout { grid-template-columns: 1fr; }
      .sidebar { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.08); }
    }
  </style>
</head>
<body>
  <div class="layout">
    <div class="sidebar">
      <div class="user-card">
        <div class="avatar" id="avatarInitial">S</div>
        <div class="user-meta">
          <strong id="userName">Student</strong>
          <small id="userRole">STUDENT</small>
        </div>
      </div>
      <div class="nav">
        <button class="nav-btn" data-page="dashboard">üìä Dashboard</button>
        <button class="nav-btn active" data-page="progress">üìà My Progress</button>
        <button class="nav-btn" data-page="courses">üìö My Courses</button>
        <button class="nav-btn" data-page="notes">üìù Notes</button>
        <button class="nav-btn" data-page="certificates">üèÜ Certificates</button>
        <button class="nav-btn logout" id="logoutBtn">üö™ Logout</button>
      </div>
    </div>

    <main>
      <div class="hero">
        <h1>My Learning Progress</h1>
        <p>Track your course completion and lesson progress</p>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <span class="stat-value" id="enrolledCount">0</span>
          <span class="stat-label">Enrolled Courses</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="completedCount">0</span>
          <span class="stat-label">Completed Courses</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="averageProgress">0%</span>
          <span class="stat-label">Average Progress</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="inProgressCount">0</span>
          <span class="stat-label">In Progress</span>
        </div>
      </div>

      <div id="progressContainer" class="panel">
        <div id="loadingState" class="loading" style="display: none;">
          <div class="spinner"></div>
          <p style="margin-top: 12px;">Loading progress...</p>
        </div>
        <div id="coursesContent"></div>
        <div id="emptyState" class="empty-state" style="display: none;">
          <h3>No Enrollments Yet</h3>
          <p>Enroll in courses to start tracking your progress</p>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = '/api';
    let currentUser = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadCurrentUser();
      await loadProgress();
      setupNavigation();
    });

    async function loadCurrentUser() {
      try {
        const response = await fetch(`${API_BASE}/auth/me`);
        if (!response.ok) throw new Error('Not authenticated');
        currentUser = await response.json();
        
        const initial = currentUser.first_name?.charAt(0) || 'S';
        document.getElementById('avatarInitial').textContent = initial;
        document.getElementById('userName').textContent = `${currentUser.first_name} ${currentUser.last_name}`;
        document.getElementById('userRole').textContent = currentUser.role;
      } catch (err) {
        console.error('Failed to load user:', err);
        window.location.href = '/auth/login.html';
      }
    }

    async function loadProgress() {
      const container = document.getElementById('progressContainer');
      const loadingState = document.getElementById('loadingState');
      const coursesContent = document.getElementById('coursesContent');
      const emptyState = document.getElementById('emptyState');
      
      loadingState.style.display = 'block';
      coursesContent.innerHTML = '';
      
      try {
        const response = await fetch(`${API_BASE}/enrollments/my-enrollments`);
        if (!response.ok) throw new Error('Failed to load enrollments');
        
        const enrollments = await response.json();
        loadingState.style.display = 'none';
        
        if (!enrollments || enrollments.length === 0) {
          emptyState.style.display = 'block';
          updateStats([], 0);
          return;
        }
        
        emptyState.style.display = 'none';
        const totalLessons = await calculateTotalLessons(enrollments);
        
        coursesContent.innerHTML = enrollments.map((enrollment, idx) => {
          const completed = enrollment.progress?.filter(p => p.is_completed).length || 0;
          const courseTotal = enrollment.progress?.length || totalLessons[enrollment.course_id] || 1;
          const percentage = Math.round((completed / courseTotal) * 100);
          const badgeText = enrollment.completion_status === 'COMPLETED' ? '‚úì Completed' : 
                           enrollment.completion_status === 'DROPPED' ? '‚úó Dropped' : '‚Üí In Progress';
          const badgeClass = enrollment.completion_status === 'COMPLETED' ? 'course-badge' :
                            enrollment.completion_status === 'DROPPED' ? 'course-badge' : 'course-badge';
          
          return `
            <div class="course-item">
              <div class="course-header">
                <div class="course-title">${enrollment.course?.title || 'Course'}</div>
                <span class="course-badge">${badgeText}</span>
              </div>
              <div class="progress-section">
                <div class="progress-label">
                  <span>Lessons Completed: ${completed}/${courseTotal}</span>
                  <span style="color: #38bdf8; font-weight: 600;">${percentage}%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${percentage}%"></div>
                </div>
              </div>
              ${enrollment.progress && enrollment.progress.length > 0 ? `
                <div class="lesson-list">
                  ${enrollment.progress.map(p => `
                    <div class="lesson-item ${p.is_completed ? 'completed' : ''}">
                      <span class="${p.is_completed ? 'check' : 'pending'}">${p.is_completed ? '‚úì' : '‚óã'}</span>
                      <span>${p.lesson?.title || 'Lesson ' + p.lesson_id}</span>
                      ${p.completed_at ? `<span style="font-size: 11px; color: #6b7c95; margin-left: auto;">${new Date(p.completed_at).toLocaleDateString()}</span>` : ''}
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              <div style="margin-top: 12px; font-size: 12px; color: #6b7c95;">
                Enrolled: ${new Date(enrollment.enrolled_at).toLocaleDateString()}
                ${enrollment.last_accessed ? ` ‚Ä¢ Last accessed: ${new Date(enrollment.last_accessed).toLocaleDateString()}` : ''}
              </div>
            </div>
          `;
        }).join('');
        
        updateStats(enrollments, totalLessons);
      } catch (err) {
        console.error('Error loading progress:', err);
        loadingState.style.display = 'none';
        coursesContent.innerHTML = '<div class="empty-state"><h3>Error Loading Progress</h3><p>' + err.message + '</p></div>';
      }
    }

    async function calculateTotalLessons(enrollments) {
      const totals = {};
      for (const enrollment of enrollments) {
        if (!totals[enrollment.course_id]) {
          try {
            const response = await fetch(`${API_BASE}/lessons/course/${enrollment.course_id}`);
            const lessons = await response.json();
            totals[enrollment.course_id] = lessons.length || 10;
          } catch {
            totals[enrollment.course_id] = 10;
          }
        }
      }
      return totals;
    }

    function updateStats(enrollments, totalLessons) {
      const enrolled = enrollments.length;
      const completed = enrollments.filter(e => e.completion_status === 'COMPLETED').length;
      const inProgress = enrollments.filter(e => e.completion_status === 'ACTIVE').length;
      
      let totalProgress = 0;
      enrollments.forEach(e => {
        const completed = e.progress?.filter(p => p.is_completed).length || 0;
        const total = e.progress?.length || totalLessons[e.course_id] || 1;
        totalProgress += (completed / total);
      });
      
      const avgProgress = enrolled > 0 ? Math.round((totalProgress / enrolled) * 100) : 0;
      
      document.getElementById('enrolledCount').textContent = enrolled;
      document.getElementById('completedCount').textContent = completed;
      document.getElementById('inProgressCount').textContent = inProgress;
      document.getElementById('averageProgress').textContent = avgProgress + '%';
    }

    function setupNavigation() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const page = e.target.getAttribute('data-page');
          
          if (page === 'progress') return; // Already on this page
          
          const pages = {
            'dashboard': '/student/student-dashboard.html',
            'courses': '/student/courses.html',
            'notes': '/student/notes.html',
            'certificates': '/student/certificate.html'
          };
          
          if (pages[page]) window.location.href = pages[page];
        });
      });
      
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
          await fetch(`${API_BASE}/auth/logout`, { method: 'POST' });
          window.location.href = '/auth/login.html';
        } catch (err) {
          console.error('Logout failed:', err);
        }
      });
    }
  </script>
</body>
</html>
