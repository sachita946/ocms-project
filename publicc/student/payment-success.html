<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Success | EduVerse</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #0f172a, #0d1c42, #0b6b6b);
      color: #eaf4f2;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .success-container {
      max-width:500px;
      background:rgba(255,255,255,0.08);
      backdrop-filter:blur(20px);
      border-radius:16px;
      padding:40px;
      text-align:center;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }

    .success-icon {
      width:80px;
      height:80px;
      margin:0 auto 20px;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:40px;
    }

    h1 {
      color:#22c55e;
      margin-bottom:10px;
      font-size:2rem;
    }

    p {
      margin-bottom:20px;
      opacity:0.9;
    }

    .loader {
      border:4px solid rgba(255,255,255,0.1);
      border-top:4px solid #22c55e;
      border-radius:50%;
      width:40px;
      height:40px;
      animation:spin 1s linear infinite;
      margin:20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .btn {
      display:inline-block;
      padding:12px 30px;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      color:#0f172a;
      text-decoration:none;
      border-radius:10px;
      font-weight:700;
      margin-top:20px;
      transition:all 0.3s;
    }

    .btn:hover {
      transform:translateY(-2px);
      box-shadow:0 10px 20px rgba(34,197,94,0.4);
    }

    .error {
      color:#ef4444;
    }
  </style>
</head>
<body>

<div class="success-container">
  <div class="success-icon">âœ“</div>
  <h1 id="statusTitle">Verifying Payment...</h1>
  <p id="statusMessage">Please wait while we confirm your payment.</p>
  <div class="loader" id="loader"></div>
  <div id="actionButtons"></div>
</div>

<script>
const API_URL = "/api";

async function verifyEsewaPayment() {
  const urlParams = new URLSearchParams(window.location.search);
  
  // Log all URL parameters for debugging
  console.log('All URL parameters:', Array.from(urlParams.entries()));
  
  // eSewa can return different parameter names depending on version/config
  // Try multiple possible parameter names
  const transactionCode = urlParams.get('refId') || urlParams.get('txnId') || urlParams.get('transaction_code') || urlParams.get('referenceId');
  const transactionUuid = urlParams.get('oid') || urlParams.get('transaction_uuid') || urlParams.get('orderId');
  const paymentId = urlParams.get('payment_id') || urlParams.get('pid');
  const totalAmount = urlParams.get('amt') || urlParams.get('total_amount') || urlParams.get('amount');

  console.log('eSewa payment success URL parameters:', {
    transactionCode, transactionUuid, paymentId, totalAmount,
    allParams: Array.from(urlParams.entries()),
    fullUrl: window.location.href,
    searchString: window.location.search
  });

  // Additional debugging - check for any eSewa-specific parameters
  const allPossibleParams = ['refId', 'txnId', 'transaction_code', 'referenceId', 'oid', 'transaction_uuid', 'orderId', 'payment_id', 'pid', 'amt', 'total_amount', 'amount'];
  const foundParams = {};
  allPossibleParams.forEach(param => {
    const value = urlParams.get(param);
    if (value) foundParams[param] = value;
  });
  console.log('Found eSewa parameters:', foundParams);

  const loader = document.getElementById('loader');
  const statusTitle = document.getElementById('statusTitle');
  const statusMessage = document.getElementById('statusMessage');
  const actionButtons = document.getElementById('actionButtons');

  // Check if this is actually a successful payment or just a redirect
  const hasAnyEsewaParams = transactionCode || transactionUuid || totalAmount;
  const hasPaymentId = !!paymentId;

  console.log('Parameter analysis:', {
    hasTransactionCode: !!transactionCode,
    hasTransactionUuid: !!transactionUuid,
    hasPaymentId: !!hasPaymentId,
    hasAmount: !!totalAmount,
    hasAnyEsewaParams,
    foundParams
  });

  if (!hasAnyEsewaParams && !hasPaymentId) {
    // No parameters at all - likely not a valid payment redirect
    loader.style.display = 'none';
    statusTitle.textContent = 'Invalid Payment Redirect';
    statusTitle.className = 'error';
    statusMessage.innerHTML = 'This page was accessed without proper payment parameters.<br><br>Please complete your payment through the proper flow.';
    actionButtons.innerHTML = '<a href="courses.html" class="btn">Back to Courses</a>';
    return;
  }

  if (!transactionCode || !paymentId) {
    // Special handling for test environment - if we have payment_id but no transaction code,
    // it might be a test scenario where eSewa doesn't return proper parameters
    if (paymentId && !transactionCode) {
      console.warn('Missing transaction code but have payment ID - attempting verification anyway');
      // Continue with verification using just payment_id
    } else {
      loader.style.display = 'none';
      statusTitle.textContent = 'Payment Verification Failed';
      statusTitle.className = 'error';

      // Show detailed error for debugging
      const missingParams = [];
      if (!transactionCode) missingParams.push('Transaction Code (refId/txnId)');
      if (!paymentId) missingParams.push('Payment ID');

      statusMessage.innerHTML = `Invalid payment parameters.<br>Missing: ${missingParams.join(', ')}<br><br>`;
      statusMessage.innerHTML += '<small style="opacity:0.7">Please check the URL parameters or contact support.</small>';

      // Show debugging info for developers
      if (foundParams && Object.keys(foundParams).length > 0) {
        statusMessage.innerHTML += '<br><br><small style="opacity:0.5">Found parameters: ' + Object.keys(foundParams).join(', ') + '</small>';
      }

      actionButtons.innerHTML = '<a href="payment.html" class="btn">Try Again</a>';

      // Log for debugging
      console.error('Missing parameters:', { transactionCode, paymentId, foundParams, allParams: Array.from(urlParams.entries()) });
      return;
    }
  }

  try {
    const token = localStorage.getItem('ocms_token');

    // Confirm payment with backend
    const response = await fetch(`${API_URL}/payments/confirm`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        transaction_code: transactionCode, // refId from eSewa
        oid: transactionUuid, // oid from eSewa
        payment_id: paymentId, // our custom parameter
        amt: totalAmount // amt from eSewa
      })
    });

    const data = await response.json();

    loader.style.display = 'none';

    if (response.ok) {
      const isTestMode = data.test_mode;
      statusTitle.textContent = 'Payment Successful!';
      statusMessage.innerHTML = `Your payment has been confirmed. You now have access to the course.${isTestMode ? '<br><small style="opacity:0.7">(Test Mode)</small>' : ''}`;

      // Check for return URL (e.g., Zoom join URL)
      const returnUrl = localStorage.getItem('payment_return_url');
      if (returnUrl) {
        localStorage.removeItem('payment_return_url');
        actionButtons.innerHTML = `<a href="${returnUrl}" class="btn">Join Course Session</a>`;
      } else {
        actionButtons.innerHTML = '<a href="courses.html?enrolled=true" class="btn">Go to My Courses</a>';
      }
    } else {
      console.error('Payment confirmation error:', data);
      statusTitle.textContent = 'Payment Confirmation Failed';
      statusTitle.className = 'error';
      statusMessage.textContent = data.message || 'Failed to confirm payment. Please contact support.';
      actionButtons.innerHTML = '<a href="payment.html" class="btn">Try Again</a>';
    }
  } catch (error) {
    console.error('Payment verification error:', error);
    loader.style.display = 'none';
    statusTitle.textContent = 'Verification Error';
    statusTitle.className = 'error';
    statusMessage.textContent = 'An error occurred while verifying your payment. Please contact support.';
    actionButtons.innerHTML = '<a href="payment.html" class="btn">Try Again</a>';
  }
}

// Run verification on page load
verifyEsewaPayment();

// Development helper: Add test payment button for localhost
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
  setTimeout(() => {
    const testButton = document.createElement('button');
    testButton.textContent = 'Test Payment Success (Dev Only)';
    testButton.className = 'btn';
    testButton.style.marginTop = '20px';
    testButton.onclick = () => {
      // Simulate successful payment with test parameters
      const testUrl = window.location.origin + window.location.pathname +
        '?refId=0000ABC&oid=OCMS-1-123&payment_id=1&amt=15000';
      window.location.href = testUrl;
    };
    document.getElementById('actionButtons').appendChild(testButton);
  }, 2000);
}
</script>

</body>
</html>